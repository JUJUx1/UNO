<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>UNO ‚Äî Multiplayer</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
:root {
  --card-w: 62px; --card-h: 96px; --radius: 10px;
  --gold: #FFD700; --red: #E8192C; --green: #1E9E46; --blue: #0156A8; --yellow: #F5D400;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  height: 100%; width: 100%;
  overflow: hidden; touch-action: none;
  font-family: 'Nunito Sans', sans-serif;
  background: radial-gradient(ellipse at 30% 20%, #1a4a2a 0%, #0a2a15 50%, #051510 100%);
  user-select: none; color: white;
}
body::before {
  content: ''; position: fixed; inset: 0;
  background-image: repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.008) 2px, rgba(255,255,255,0.008) 4px);
  pointer-events: none; z-index: 0;
}
.screen {
  position: fixed; inset: 0; z-index: 200;
  background: radial-gradient(ellipse at 30% 20%, #1a4a2a 0%, #0a2a15 50%, #051510 100%);
  overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;
}
.screen.hidden { display: none; }
.screen::before {
  content: ''; position: fixed; inset: 0;
  background-image: repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.008) 2px, rgba(255,255,255,0.008) 4px);
  pointer-events: none; z-index: -1;
}
.screen-inner {
  min-height: 100%; display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 28px 20px;
  padding-top: max(28px, env(safe-area-inset-top));
  padding-bottom: max(28px, env(safe-area-inset-bottom));
}
.big-logo {
  font-family: 'Nunito', sans-serif; font-weight: 900;
  font-size: clamp(68px, 16vw, 100px); color: var(--gold);
  letter-spacing: -4px; transform: rotate(-5deg); line-height: 1;
  text-shadow: 0 0 40px rgba(255,215,0,0.6), 4px 4px 0 #b8860b, 8px 8px 0 #7a5a00;
  animation: logoPulse 1.8s ease-in-out infinite; position: relative; z-index: 2;
}
@keyframes logoPulse {
  0%,100% { text-shadow: 0 0 40px rgba(255,215,0,0.6), 4px 4px 0 #b8860b, 8px 8px 0 #7a5a00; }
  50%      { text-shadow: 0 0 90px rgba(255,215,0,1), 4px 4px 0 #b8860b, 8px 8px 0 #7a5a00; }
}
.sub-title {
  font-weight: 700; font-size: 11px; color: rgba(255,255,255,0.4);
  letter-spacing: 5px; text-transform: uppercase; margin: 6px 0 40px; z-index: 2;
}
.card-panel {
  background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.13);
  border-radius: 22px; padding: 26px 24px 22px; width: 100%; max-width: 360px;
  backdrop-filter: blur(10px); box-shadow: 0 20px 60px rgba(0,0,0,0.5); z-index: 2;
}
.card-panel h2 { font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 19px; text-align: center; margin-bottom: 18px; }
.field-label { display: block; font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.45); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 6px; }
.inp {
  width: 100%; background: rgba(0,0,0,0.3); border: 1.5px solid rgba(255,255,255,0.14);
  border-radius: 12px; padding: 13px 15px; font-family: 'Nunito', sans-serif;
  font-weight: 700; font-size: 15px; color: white; outline: none;
  transition: border-color 0.2s, box-shadow 0.2s; -webkit-appearance: none; margin-bottom: 14px;
}
.inp::placeholder { color: rgba(255,255,255,0.28); }
.inp:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(255,215,0,0.15); }
.divider { display: flex; align-items: center; gap: 10px; margin: 16px 0; color: rgba(255,255,255,0.28); font-size: 11px; font-weight: 700; }
.divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }
.btn-gold {
  display: block; width: 100%;
  background: linear-gradient(145deg, var(--gold), #ff8c00); color: #1a0a00;
  border: none; border-radius: 14px; padding: 15px; cursor: pointer;
  font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 16px;
  box-shadow: 0 4px 20px rgba(255,165,0,0.4), 0 2px 0 #7a3a00;
  transition: transform 0.15s, box-shadow 0.15s;
}
.btn-gold:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(255,165,0,0.55); }
.btn-gold:active { transform: scale(0.97); }
.btn-gold:disabled { opacity: 0.35; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-ghost {
  display: block; width: 100%; margin-top: 10px;
  background: rgba(255,255,255,0.09); color: white;
  border: 1.5px solid rgba(255,255,255,0.18); border-radius: 14px; padding: 13px;
  font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 15px; cursor: pointer;
  transition: background 0.15s, transform 0.15s;
}
.btn-ghost:hover { background: rgba(255,255,255,0.15); transform: translateY(-1px); }
.btn-ghost:active { transform: scale(0.97); }
.err-box { background: rgba(232,25,44,0.14); border: 1px solid rgba(232,25,44,0.3); border-radius: 10px; padding: 10px 14px; font-size: 13px; font-weight: 700; margin-top: 12px; display: none; }
.err-box.show { display: block; }

/* AUTH */
#authScreen { z-index: 300; }
.auth-tabs { display: flex; margin-bottom: 22px; border-radius: 12px; overflow: hidden; border: 1.5px solid rgba(255,255,255,0.12); }
.auth-tab { flex: 1; padding: 10px; font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 13px; background: transparent; color: rgba(255,255,255,0.45); border: none; cursor: pointer; transition: background 0.2s, color 0.2s; }
.auth-tab.active { background: rgba(255,215,0,0.18); color: var(--gold); }
.avatar-upload-wrap { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 18px; }
.avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: rgba(0,0,0,0.35); border: 3px solid rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; font-size: 36px; cursor: pointer; overflow: hidden; position: relative; transition: border-color 0.2s; }
.avatar-preview:hover { border-color: var(--gold); }
.avatar-preview img { width: 100%; height: 100%; object-fit: cover; display: block; }
.avatar-preview-hint { font-size: 10px; color: rgba(255,255,255,0.35); font-weight: 700; text-align: center; }
.avatar-file-inp { display: none; }

/* LOBBY */
.share-box { background: rgba(0,0,0,0.3); border: 1.5px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 11px 13px; margin-bottom: 14px; display: flex; align-items: center; gap: 9px; }
.share-url { flex: 1; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 11px; color: rgba(255,255,255,0.65); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.copy-btn { flex-shrink: 0; background: linear-gradient(145deg, var(--gold), #ff8c00); color: #1a0a00; border: none; border-radius: 8px; padding: 6px 11px; font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 11px; cursor: pointer; }
.player-list { list-style: none; display: flex; flex-direction: column; gap: 7px; margin-bottom: 18px; max-height: 180px; overflow-y: auto; }
.player-list li { display: flex; align-items: center; gap: 9px; background: rgba(255,255,255,0.055); border: 1px solid rgba(255,255,255,0.09); border-radius: 10px; padding: 9px 12px; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 14px; animation: slideIn 0.3s ease; }
@keyframes slideIn { from { opacity:0; transform:translateX(-10px); } to { opacity:1; transform:translateX(0); } }
.host-badge { margin-left: auto; font-size: 10px; background: var(--gold); color: #1a0a00; padding: 2px 7px; border-radius: 8px; font-weight: 900; }
.conn-dot { width: 8px; height: 8px; border-radius: 50%; background: #2ecc71; box-shadow: 0 0 6px #2ecc71; margin-left: auto; flex-shrink: 0; }
.settings-row { display: flex; gap: 9px; margin-bottom: 15px; }
.setting-box { flex: 1; background: rgba(0,0,0,0.28); border: 1.5px solid rgba(255,255,255,0.09); border-radius: 10px; padding: 9px 11px; display: flex; flex-direction: column; gap: 4px; }
.setting-box label { font-size: 9px; font-weight: 700; color: rgba(255,255,255,0.4); letter-spacing: 1px; text-transform: uppercase; }
.setting-box select { background: transparent; border: none; color: white; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 14px; outline: none; cursor: pointer; -webkit-appearance: none; }
.setting-box select option { background: #0a2a15; }
@keyframes blink { 0%,100%{opacity:0.3;} 50%{opacity:1;} }

/* GAME SCREEN */
#gameScreen { position: fixed; inset: 0; display: flex; flex-direction: column; z-index: 1; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
#gameScreen.hidden { display: none; }
.hdr { display: flex; align-items: center; justify-content: space-between; padding: 8px 14px 4px; flex-shrink: 0; }
.logo-sm { font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 26px; color: var(--gold); text-shadow: 0 0 18px rgba(255,215,0,0.4), 2px 2px 0 #b8860b, 4px 4px 0 #7a5a00; transform: rotate(-3deg); }
.dir-label { font-size: 10px; color: rgba(255,255,255,0.4); font-weight: 700; }
.turn-bar { display: flex; align-items: center; justify-content: center; padding: 4px 14px 2px; flex-shrink: 0; }
.turn-pill { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 14px; background: rgba(255,255,255,0.13); padding: 5px 18px; border-radius: 20px; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: background 0.3s, color 0.3s; text-align: center; }
.turn-pill.mine { background: linear-gradient(135deg, var(--gold), #ff8c00); color: #1a0a00; animation: pulseTurn 1.2s ease-in-out infinite; }
@keyframes pulseTurn { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }

/* Opponents */
.opp-scroll { width: 100%; overflow-x: auto; overflow-y: hidden; scrollbar-width: none; flex-shrink: 0; padding: 2px 10px 3px; }
.opp-scroll::-webkit-scrollbar { display: none; }
.opp-row { display: flex; gap: 7px; width: max-content; min-width: 100%; justify-content: center; }
.opp-panel { background: rgba(255,255,255,0.055); border: 1.5px solid rgba(255,255,255,0.09); border-radius: 13px; padding: 7px 9px; min-width: 90px; max-width: 115px; flex-shrink: 0; position: relative; transition: border-color 0.25s, box-shadow 0.25s; }
.opp-panel.active { border-color: var(--gold); box-shadow: 0 0 14px rgba(255,215,0,0.28); }
.opp-top { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
.opp-av { width: 24px; height: 24px; border-radius: 50%; font-size: 13px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.28); border: 2px solid transparent; flex-shrink: 0; position: relative; overflow: hidden; transition: border-color 0.25s; }
.opp-panel.active .opp-av { border-color: var(--gold); }
.opp-panel.active .opp-av::after { content: ''; position: absolute; inset: -3px; border-radius: 50%; border: 2px solid var(--gold); animation: spinRing 2s linear infinite; }
@keyframes spinRing { to { transform: rotate(360deg); } }
.opp-av img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.opp-name { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
.opp-cards { display: flex; justify-content: center; margin-bottom: 3px; min-height: 26px; }
.opp-cm { width: 14px; height: 24px; border-radius: 3px; margin-left: -4px; border: 1px solid rgba(255,255,255,0.2); overflow: hidden; flex-shrink: 0; }
.opp-cm:first-child { margin-left: 0; }
.opp-cm img { width: 100%; height: 100%; object-fit: cover; display: block; }
.opp-cnt { font-size: 9px; color: rgba(255,255,255,0.45); font-weight: 700; text-align: center; }
.opp-uno-badge { position: absolute; top: -6px; right: -5px; background: var(--red); color: white; font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 9px; padding: 2px 5px; border-radius: 7px; animation: unoFlash 0.6s ease-in-out infinite alternate; box-shadow: 0 2px 6px rgba(232,25,44,0.5); }
@keyframes unoFlash { from{transform:scale(1);} to{transform:scale(1.12);} }

/* Turn strip */
.turn-strip { display: flex; gap: 5px; justify-content: center; padding: 1px 12px 3px; flex-shrink: 0; overflow-x: auto; scrollbar-width: none; }
.turn-strip::-webkit-scrollbar { display: none; }
.t-dot { width: 7px; height: 7px; border-radius: 50%; background: rgba(255,255,255,0.18); flex-shrink: 0; transition: background 0.25s, transform 0.25s; }
.t-dot.now { background: var(--gold); transform: scale(1.5); box-shadow: 0 0 6px rgba(255,215,0,0.8); }

/* Center */
.center-area { flex: 1; display: flex; align-items: center; justify-content: center; gap: 18px; width: 100%; padding: 0 12px; min-height: 0; }
.pile-wrap { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.pile-label { font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 9px; color: rgba(255,255,255,0.38); text-transform: uppercase; letter-spacing: 1px; }
.deck-stack { width: var(--card-w); height: var(--card-h); position: relative; cursor: pointer; -webkit-tap-highlight-color: transparent; }
.deck-stack .sh { position: absolute; inset: 0; border-radius: var(--radius); background: rgba(0,0,0,0.3); }
.deck-stack .sh:nth-child(1) { transform: translate(4px,4px); }
.deck-stack .sh:nth-child(2) { transform: translate(2px,2px); }
.deck-top { position: absolute; inset: 0; border-radius: var(--radius); overflow: hidden; box-shadow: 0 4px 14px rgba(0,0,0,0.6); transition: transform 0.15s; }
.deck-top img { width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none; }
.deck-stack:active .deck-top { transform: scale(0.93) translateY(3px); }
.deck-remaining { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 9px; color: rgba(255,255,255,0.3); margin-top: 2px; }
.discard-pile { width: var(--card-w); height: var(--card-h); border-radius: var(--radius); overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.5); transition: box-shadow 0.35s; }
.discard-pile img { width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none; }
.game-mid { display: flex; flex-direction: column; align-items: center; gap: 7px; }
.color-swatch { width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; transition: background 0.35s, box-shadow 0.35s; }
.color-lbl { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 9px; color: rgba(255,255,255,0.45); text-transform: uppercase; letter-spacing: 0.5px; }

/* Player hand */
.player-area { width: 100%; padding: 0 0 6px; flex-shrink: 0; }
.your-info { display: flex; align-items: center; justify-content: space-between; padding: 0 14px; margin-bottom: 3px; }
.your-name { display: flex; align-items: center; gap: 6px; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 13px; color: var(--gold); }
.your-cnt { font-size: 11px; color: rgba(255,255,255,0.5); font-weight: 600; }
.scroll-hint { text-align: center; font-size: 9px; color: rgba(255,255,255,0.2); font-weight: 600; min-height: 13px; }
.hand-container { display: flex; justify-content: flex-start; align-items: flex-end; overflow-x: scroll; overflow-y: visible; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding: 36px 20px 8px; min-height: calc(var(--card-h) + 44px); }
.hand-container::-webkit-scrollbar { display: none; }
.hand-inner { display: flex; align-items: flex-end; min-width: min-content; margin: 0 auto; }
.hand-card { width: var(--card-w); height: var(--card-h); border-radius: var(--radius); flex-shrink: 0; margin-left: -16px; cursor: pointer; position: relative; transform-origin: bottom center; box-shadow: 0 4px 12px rgba(0,0,0,0.55); overflow: hidden; -webkit-tap-highlight-color: transparent; transition: transform 0.22s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.2s, filter 0.2s; }
.hand-card:first-child { margin-left: 0; }
.hand-card img { width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none; border-radius: var(--radius); }
.hand-card.playable:hover { transform: translateY(-18px) scale(1.07); z-index: 50; box-shadow: 0 14px 28px rgba(0,0,0,0.6); }
.hand-card.dead { filter: brightness(0.38) saturate(0.3); cursor: not-allowed; }
.hand-card.selected { animation: cardPickUp 0.32s cubic-bezier(0.34,1.56,0.64,1) forwards; z-index: 60; overflow: visible; }
@keyframes cardPickUp {
  0%   { transform:translateY(0) scale(1); box-shadow:0 4px 12px rgba(0,0,0,0.55); }
  40%  { transform:translateY(-36px) scale(1.14) rotate(-2deg); box-shadow:0 22px 38px rgba(0,0,0,0.7),0 0 0 3px var(--gold),0 0 28px rgba(255,215,0,0.6); }
  70%  { transform:translateY(-28px) scale(1.11) rotate(0deg); }
  100% { transform:translateY(-28px) scale(1.11); box-shadow:0 18px 36px rgba(0,0,0,0.7),0 0 0 3px var(--gold),0 0 18px rgba(255,215,0,0.5); }
}
.hand-card.selected::after { content:''; position:absolute; inset:0; border-radius:var(--radius); background:linear-gradient(115deg,transparent 30%,rgba(255,255,255,0.32) 50%,transparent 70%); background-size:200% 100%; animation:shimmer 0.5s ease forwards; pointer-events:none; z-index:5; }
@keyframes shimmer { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }
.tap-lbl { display:none; position:absolute; top:-26px; left:50%; transform:translateX(-50%); background:var(--gold); color:#1a0a00; font-family:'Nunito',sans-serif; font-weight:900; font-size:9px; padding:3px 8px; border-radius:9px; white-space:nowrap; pointer-events:none; z-index:10; animation:tapFloat 0.55s ease-in-out infinite alternate; }
.hand-card.selected .tap-lbl { display:block; }
@keyframes tapFloat { from{transform:translateX(-50%) translateY(0);} to{transform:translateX(-50%) translateY(-4px);} }
@keyframes popIn { 0%{transform:scale(0.75) rotate(-4deg);} 60%{transform:scale(1.1) rotate(1deg);} 100%{transform:scale(1) rotate(0);} }
.pop-in { animation:popIn 0.3s cubic-bezier(0.34,1.56,0.64,1) forwards; }

/* Action bar */
.action-bar { display:flex; gap:10px; padding:4px 14px 10px; justify-content:center; align-items:center; flex-shrink:0; z-index:10; }
.btn-act { background:rgba(255,255,255,0.09); border:1.5px solid rgba(255,255,255,0.18); border-radius:28px; padding:0; cursor:pointer; transition:all 0.15s; -webkit-tap-highlight-color:transparent; display:flex; align-items:center; justify-content:center; overflow:hidden; height:46px; }
.btn-act:hover:not(:disabled) { background:rgba(255,255,255,0.15); transform:translateY(-1px); }
.btn-act:active:not(:disabled) { transform:scale(0.93); }
.btn-act:disabled { opacity:0.3; cursor:not-allowed; }
.btn-act img { height:38px; width:auto; display:block; pointer-events:none; }
.btn-act-fallback { font-family:'Nunito',sans-serif; font-weight:900; font-size:14px; color:white; padding:0 18px; }
#btnDraw { background:linear-gradient(145deg,#1a6a9e,#0d4060); border-color:rgba(255,255,255,0.12); padding:0 4px; }
#btnUno  { background:linear-gradient(145deg,#e8192c,#8b0000); border-color:rgba(255,255,255,0.12); padding:0 4px; }
#btnChat { font-size:19px; width:46px; height:46px; border-radius:50%; }

/* Overlays */
.overlay { position:fixed; inset:0; background:rgba(0,0,0,0.72); z-index:500; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(6px); padding:24px; }
.modal { background:linear-gradient(145deg,#1a3d2a,#0d2018); border:1px solid rgba(255,255,255,0.14); border-radius:22px; padding:26px 22px 22px; text-align:center; max-width:330px; width:100%; box-shadow:0 24px 60px rgba(0,0,0,0.7); animation:modalIn 0.3s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes modalIn { from{transform:scale(0.7) translateY(20px);opacity:0;} to{transform:scale(1) translateY(0);opacity:1;} }
.modal-ttl { font-family:'Nunito',sans-serif; font-weight:900; font-size:19px; margin-bottom:5px; }
.modal-sub { font-size:12px; color:rgba(255,255,255,0.5); margin-bottom:18px; }
.color-grid { display:grid; grid-template-columns:1fr 1fr; gap:9px; }
.color-btn { padding:15px 10px; border-radius:13px; border:2px solid rgba(255,255,255,0.2); font-family:'Nunito',sans-serif; font-weight:900; font-size:14px; cursor:pointer; transition:transform 0.15s; color:white; }
.color-btn:hover { transform:scale(1.06); }
.color-btn:active { transform:scale(0.95); }
.cb-r{background:linear-gradient(145deg,#e8192c,#8b0000);}
.cb-y{background:linear-gradient(145deg,#f5d400,#b8860b);color:#1a0a00;}
.cb-g{background:linear-gradient(145deg,#1e9e46,#0d5525);}
.cb-b{background:linear-gradient(145deg,#0156a8,#012d60);}

/* Win screen */
.win-emoji { font-size:52px; margin-bottom:8px; animation:winBounce 0.5s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes winBounce { from{transform:scale(0.4) rotate(-12deg);opacity:0;} to{transform:scale(1) rotate(0);opacity:1;} }
.win-ttl { font-family:'Nunito',sans-serif; font-weight:900; font-size:26px; color:var(--gold); text-shadow:2px 2px 0 #7a5a00; margin-bottom:6px; }
.win-sub { font-size:13px; color:rgba(255,255,255,0.55); margin-bottom:16px; }
.score-list { list-style:none; margin-bottom:18px; text-align:left; display:flex; flex-direction:column; gap:5px; }
.score-list li { display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.055); border-radius:8px; padding:7px 11px; font-family:'Nunito',sans-serif; font-weight:800; font-size:13px; overflow:hidden; }
.score-pos { font-size:15px; width:22px; flex-shrink:0; text-align:center; }
.win-btns { display:flex; gap:9px; justify-content:center; }
.btn-restart { background:linear-gradient(145deg,var(--gold),#ff8c00); color:#1a0a00; padding:12px 28px; border-radius:28px; border:none; font-family:'Nunito',sans-serif; font-weight:900; font-size:14px; cursor:pointer; transition:transform 0.15s; }
.btn-restart:active { transform:scale(0.94); }
.btn-leave-sm { background:rgba(255,255,255,0.09); color:white; padding:11px 20px; border-radius:28px; border:1.5px solid rgba(255,255,255,0.18); font-family:'Nunito',sans-serif; font-weight:900; font-size:14px; cursor:pointer; }

/* Toast */
.toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(12px); background:rgba(8,8,18,0.93); color:white; padding:8px 18px; border-radius:20px; font-family:'Nunito',sans-serif; font-weight:700; font-size:13px; z-index:600; opacity:0; transition:all 0.28s; white-space:nowrap; border:1px solid rgba(255,255,255,0.1); backdrop-filter:blur(6px); pointer-events:none; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* Confetti */
.confetti-p { position:fixed; top:-12px; animation:confettiFall linear forwards; z-index:700; pointer-events:none; }
@keyframes confettiFall { to{ transform:translateY(105vh) rotate(720deg); opacity:0; } }

/* Connecting */
.connecting { position:fixed; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); border:1px solid rgba(255,255,255,0.13); color:rgba(255,255,255,0.85); font-family:'Nunito',sans-serif; font-weight:700; font-size:12px; padding:6px 14px; border-radius:20px; z-index:900; display:none; align-items:center; gap:8px; backdrop-filter:blur(8px); }
.connecting.show { display:flex; }
.spin { width:10px; height:10px; border-radius:50%; border:2px solid rgba(255,255,255,0.28); border-top-color:var(--gold); animation:spin 0.8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg);} }

/* Chat */
.chat-panel { position:fixed; bottom:0; right:0; width:min(320px,100%); height:58vh; max-height:400px; background:linear-gradient(145deg,#1a3d2a,#0d2018); border:1px solid rgba(255,255,255,0.13); border-radius:20px 20px 0 0; z-index:300; display:flex; flex-direction:column; transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1); box-shadow:0 -10px 40px rgba(0,0,0,0.5); }
.chat-panel.open { transform:translateY(0); }
.chat-hdr { padding:13px 16px 9px; border-bottom:1px solid rgba(255,255,255,0.09); display:flex; align-items:center; justify-content:space-between; font-family:'Nunito',sans-serif; font-weight:900; font-size:14px; }
.chat-close { background:none; border:none; color:rgba(255,255,255,0.45); font-size:19px; cursor:pointer; }
.emoji-bar { display:flex; gap:5px; padding:6px 12px; border-bottom:1px solid rgba(255,255,255,0.07); overflow-x:auto; scrollbar-width:none; }
.emoji-bar::-webkit-scrollbar { display:none; }
.e-btn { background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.09); border-radius:7px; padding:4px 7px; font-size:17px; cursor:pointer; flex-shrink:0; transition:transform 0.15s; }
.e-btn:hover { transform:scale(1.2); }
.chat-msgs { flex:1; overflow-y:auto; padding:9px 12px; display:flex; flex-direction:column; gap:7px; scrollbar-width:thin; scrollbar-color:rgba(255,255,255,0.08) transparent; }
.chat-msg { background:rgba(255,255,255,0.065); border-radius:9px; padding:6px 10px; font-size:12px; }
.chat-msg .mn { font-weight:900; color:var(--gold); font-size:10px; margin-bottom:2px; }
.chat-msg .mt { color:rgba(255,255,255,0.82); line-height:1.4; }
.chat-msg.sys { background:rgba(255,215,0,0.07); border:1px solid rgba(255,215,0,0.12); }
.chat-msg.mine { background:rgba(1,86,168,0.22); }
.chat-in { display:flex; gap:7px; padding:9px 12px 13px; border-top:1px solid rgba(255,255,255,0.09); }
.chat-in input { flex:1; background:rgba(0,0,0,0.28); border:1.5px solid rgba(255,255,255,0.1); border-radius:9px; padding:9px 11px; font-family:'Nunito',sans-serif; font-weight:700; font-size:13px; color:white; outline:none; }
.chat-in input:focus { border-color:var(--gold); }
.chat-in input::placeholder { color:rgba(255,255,255,0.28); }
.chat-send { background:linear-gradient(145deg,var(--gold),#ff8c00); color:#1a0a00; border:none; border-radius:9px; padding:9px 13px; font-family:'Nunito',sans-serif; font-weight:900; font-size:13px; cursor:pointer; }
.float-emoji { position:fixed; font-size:30px; pointer-events:none; z-index:800; animation:floatUp 2s ease forwards; }
@keyframes floatUp { 0%{opacity:1;transform:translateY(0) scale(1);} 80%{opacity:1;} 100%{opacity:0;transform:translateY(-90px) scale(1.4);} }
.fs-btn { position:fixed; bottom:10px; right:10px; width:36px; height:36px; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.18); border-radius:8px; color:white; font-size:15px; cursor:pointer; z-index:100; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.action-banner { position:fixed; top:60px; left:50%; transform:translateX(-50%) translateY(-20px); background:rgba(8,8,18,0.92); border:1.5px solid rgba(255,215,0,0.3); color:white; padding:8px 20px; border-radius:20px; font-family:'Nunito',sans-serif; font-weight:800; font-size:13px; z-index:650; opacity:0; transition:all 0.3s; white-space:nowrap; pointer-events:none; backdrop-filter:blur(6px); }
.action-banner.show { opacity:1; transform:translateX(-50%) translateY(0); }
@media (max-height:680px) { :root{--card-w:54px;--card-h:83px;} .hand-container{padding:15px 10px 3px;} .opp-panel{min-width:78px;} }
@media (max-height:580px) { :root{--card-w:46px;--card-h:72px;} }

/* ===== 3D CARD FLIP ===== */
.card-flip-container { perspective: 800px; position:fixed; pointer-events:none; z-index:800; top:0; left:0; width:100%; height:100%; }
.card-flip { width:62px; height:96px; position:absolute; transform-style:preserve-3d; animation:card3dFlip 0.55s cubic-bezier(0.4,0,0.2,1) forwards; border-radius:10px; }
@keyframes card3dFlip {
  0%   { transform:scale(1) rotateY(0deg) translateY(0); opacity:1; }
  40%  { transform:scale(1.2) rotateY(90deg) translateY(-30px); }
  70%  { transform:scale(1.1) rotateY(180deg) translateY(-20px); }
  100% { transform:scale(0.8) rotateY(360deg) translateY(60px); opacity:0; }
}
.card-flip-face { position:absolute; inset:0; border-radius:10px; backface-visibility:hidden; display:flex; align-items:center; justify-content:center; font-family:'Nunito',sans-serif; font-weight:900; font-size:18px; box-shadow:0 8px 24px rgba(0,0,0,0.6); }
.card-flip-front { background:linear-gradient(145deg,#e8192c,#8b0000); color:white; }
.card-flip-back  { background:linear-gradient(145deg,#1a3a8a,#0d2060); color:#e8192c; transform:rotateY(180deg); }

/* ===== PARTICLES ===== */
.particle { position:fixed; pointer-events:none; z-index:750; border-radius:50%; animation:particleBurst linear forwards; }
@keyframes particleBurst { 0%{opacity:1;transform:translate(0,0) scale(1);} 100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0.2);} }
.particle-star { position:fixed; pointer-events:none; z-index:750; font-size:20px; animation:starFloat 1s ease-out forwards; }
@keyframes starFloat { 0%{opacity:1;transform:translate(0,0) scale(1) rotate(0deg);} 100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0.3) rotate(360deg);} }

/* ===== DYNAMIC BACKGROUND ===== */
body { transition: background 1.5s ease; }
body.bg-red    { background: radial-gradient(ellipse at 30% 20%, #4a1a1a 0%, #2a0a0a 50%, #150505 100%) !important; }
body.bg-yellow { background: radial-gradient(ellipse at 30% 20%, #4a4a1a 0%, #2a2a0a 50%, #151505 100%) !important; }
body.bg-green  { background: radial-gradient(ellipse at 30% 20%, #1a4a2a 0%, #0a2a15 50%, #051510 100%) !important; }
body.bg-blue   { background: radial-gradient(ellipse at 30% 20%, #1a2a4a 0%, #0a1525 50%, #050a15 100%) !important; }
body.bg-tension { background: radial-gradient(ellipse at 50% 50%, #4a1a0a 0%, #2a0a05 50%, #150503 100%) !important; animation: bgPulse 1s ease-in-out infinite; }
@keyframes bgPulse { 0%,100%{filter:brightness(1);} 50%{filter:brightness(1.15);} }
body.bg-win { background: radial-gradient(ellipse at 50% 50%, #4a3a0a 0%, #2a1a05 50%, #150a00 100%) !important; }

/* ===== XP SYSTEM ===== */
.xp-bar-wrap { position:fixed; top:env(safe-area-inset-top,0); right:0; left:0; z-index:50; padding:6px 14px 0; pointer-events:none; display:none; }
.xp-bar-wrap.show { display:block; }
.xp-bar-inner { display:flex; align-items:center; gap:8px; }
.xp-level-badge { background:linear-gradient(145deg,var(--gold),#ff8c00); color:#1a0a00; font-family:'Nunito',sans-serif; font-weight:900; font-size:10px; padding:2px 8px; border-radius:20px; flex-shrink:0; white-space:nowrap; }
.xp-bar-track { flex:1; height:5px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden; }
.xp-bar-fill { height:100%; background:linear-gradient(90deg,var(--gold),#ff8c00); border-radius:3px; transition:width 0.8s cubic-bezier(0.34,1.56,0.64,1); }
.xp-gain-pop { position:fixed; font-family:'Nunito',sans-serif; font-weight:900; font-size:16px; color:var(--gold); pointer-events:none; z-index:800; text-shadow:0 0 12px rgba(255,215,0,0.8); animation:xpPop 1.4s ease forwards; }
@keyframes xpPop { 0%{opacity:0;transform:translateY(0) scale(0.5);} 20%{opacity:1;transform:translateY(-10px) scale(1.2);} 80%{opacity:1;transform:translateY(-40px) scale(1);} 100%{opacity:0;transform:translateY(-60px) scale(0.8);} }

/* ===== LEADERBOARD ===== */
.lb-btn { position:fixed; top:calc(env(safe-area-inset-top,0) + 8px); right:52px; z-index:150; width:36px; height:36px; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.18); border-radius:8px; color:var(--gold); font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.lb-panel { position:fixed; inset:0; z-index:600; background:rgba(0,0,0,0.88); backdrop-filter:blur(12px); display:flex; align-items:center; justify-content:center; padding:24px; }
.lb-modal { background:linear-gradient(145deg,#1a3d2a,#0d2018); border:1px solid rgba(255,255,255,0.14); border-radius:22px; padding:24px 20px 20px; width:100%; max-width:340px; max-height:80vh; overflow-y:auto; }
.lb-modal h2 { font-family:'Nunito',sans-serif; font-weight:900; font-size:20px; text-align:center; color:var(--gold); margin-bottom:4px; }
.lb-subtitle { font-size:11px; color:rgba(255,255,255,0.35); text-align:center; margin-bottom:16px; }
.lb-list { list-style:none; display:flex; flex-direction:column; gap:6px; margin-bottom:16px; }
.lb-item { display:flex; align-items:center; gap:9px; background:rgba(255,255,255,0.055); border-radius:10px; padding:9px 12px; font-family:'Nunito',sans-serif; font-weight:800; font-size:13px; }
.lb-item.me { background:rgba(255,215,0,0.1); border:1px solid rgba(255,215,0,0.25); }
.lb-rank { width:22px; text-align:center; font-size:15px; flex-shrink:0; }
.lb-stat { margin-left:auto; font-size:11px; color:rgba(255,255,255,0.45); white-space:nowrap; }
.lb-wins { color:var(--gold); font-weight:900; }
.lb-close { display:block; width:100%; background:rgba(255,255,255,0.09); color:white; border:1.5px solid rgba(255,255,255,0.18); border-radius:14px; padding:12px; font-family:'Nunito',sans-serif; font-weight:900; font-size:14px; cursor:pointer; }

/* ===== VOICE CHAT ===== */
.vc-btn { position:fixed; top:calc(env(safe-area-inset-top,0) + 8px); right:92px; z-index:150; width:36px; height:36px; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.18); border-radius:8px; color:white; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px); transition:background 0.2s, border-color 0.2s; }
.vc-btn.active { background:rgba(232,25,44,0.3); border-color:rgba(232,25,44,0.6); }
.vc-btn.speaking { animation:vcPulse 0.6s ease-in-out infinite; }
@keyframes vcPulse { 0%,100%{box-shadow:0 0 0 0 rgba(232,25,44,0.4);} 50%{box-shadow:0 0 0 8px rgba(232,25,44,0);} }
.vc-indicators { position:fixed; top:calc(env(safe-area-inset-top,0) + 52px); right:10px; z-index:150; display:flex; flex-direction:column; gap:4px; pointer-events:none; }
.vc-pip { display:flex; align-items:center; gap:5px; background:rgba(0,0,0,0.7); border-radius:20px; padding:3px 8px 3px 5px; font-family:'Nunito',sans-serif; font-weight:800; font-size:10px; border:1px solid rgba(255,255,255,0.1); opacity:0; transition:opacity 0.3s; }
.vc-pip.speaking { opacity:1; border-color:rgba(30,200,70,0.5); }
.vc-mic-dot { width:7px; height:7px; border-radius:50%; background:#2ecc71; animation:micBlink 0.4s ease-in-out infinite; }
@keyframes micBlink { 0%,100%{opacity:0.4;} 50%{opacity:1;} }

/* ===== AI BOT ===== */
.ai-badge { background:linear-gradient(135deg,#7c3aed,#4c1d95); color:white; font-size:9px; font-family:'Nunito',sans-serif; font-weight:900; padding:1px 5px; border-radius:5px; }

/* ===== REPLAY ===== */
.replay-btn { background:rgba(255,255,255,0.09); color:white; padding:11px 20px; border-radius:28px; border:1.5px solid rgba(255,255,255,0.18); font-family:'Nunito',sans-serif; font-weight:900; font-size:14px; cursor:pointer; }
.replay-panel { position:fixed; inset:0; z-index:700; background:rgba(0,0,0,0.92); backdrop-filter:blur(12px); display:flex; align-items:center; justify-content:center; padding:24px; }
.replay-modal { background:linear-gradient(145deg,#1a3d2a,#0d2018); border:1px solid rgba(255,255,255,0.14); border-radius:22px; padding:22px 20px 18px; width:100%; max-width:340px; }
.replay-modal h2 { font-family:'Nunito',sans-serif; font-weight:900; font-size:18px; text-align:center; color:var(--gold); margin-bottom:14px; }
.replay-timeline { display:flex; flex-direction:column; gap:6px; max-height:340px; overflow-y:auto; margin-bottom:14px; padding-right:4px; scrollbar-width:thin; scrollbar-color:rgba(255,255,255,0.1) transparent; }
.replay-event { display:flex; align-items:center; gap:9px; background:rgba(255,255,255,0.055); border-radius:9px; padding:8px 11px; font-size:12px; font-family:'Nunito',sans-serif; font-weight:700; }
.replay-event .re-icon { font-size:16px; flex-shrink:0; }
.replay-event .re-time { font-size:10px; color:rgba(255,255,255,0.35); margin-left:auto; white-space:nowrap; }
.replay-event.re-win { background:rgba(255,215,0,0.1); border:1px solid rgba(255,215,0,0.2); }
</style>
</head>
<body>

<!-- AUTH -->
<div id="authScreen" class="screen">
<div class="screen-inner">
  <div class="big-logo">UNO</div>
  <div class="sub-title">Multiplayer</div>
  <div class="card-panel">
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">üîë Login</button>
      <button class="auth-tab" id="tabRegister" onclick="switchAuthTab('register')">‚ú® Register</button>
    </div>
    <div id="authLoginForm">
      <div class="avatar-upload-wrap">
        <div class="avatar-preview" id="loginAvatarPreview">üë§</div>
        <div class="avatar-preview-hint">Your saved avatar</div>
      </div>
      <label class="field-label">Username</label>
      <input class="inp" type="text" id="loginUsername" placeholder="Your username‚Ä¶" maxlength="16" autocomplete="off" spellcheck="false">
      <label class="field-label">Password</label>
      <input class="inp" type="password" id="loginPassword" placeholder="Your password‚Ä¶">
      <button class="btn-gold" onclick="doLogin()">üéÆ Let's Play!</button>
      <div class="err-box" id="loginAuthError"></div>
    </div>
    <div id="authRegisterForm" style="display:none">
      <div class="avatar-upload-wrap">
        <div class="avatar-preview" id="registerAvatarPreview" onclick="document.getElementById('avatarFileInp').click()">üì∑</div>
        <div class="avatar-preview-hint">Tap to upload photo</div>
        <input class="avatar-file-inp" type="file" id="avatarFileInp" accept="image/*" onchange="handleAvatarUpload(this)">
      </div>
      <label class="field-label">Username</label>
      <input class="inp" type="text" id="registerUsername" placeholder="Choose a username‚Ä¶" maxlength="16" autocomplete="off" spellcheck="false">
      <label class="field-label">Password</label>
      <input class="inp" type="password" id="registerPassword" placeholder="Choose a password‚Ä¶">
      <label class="field-label">Confirm Password</label>
      <input class="inp" type="password" id="registerPassword2" placeholder="Repeat password‚Ä¶">
      <button class="btn-gold" onclick="doRegister()">üöÄ Create Account</button>
      <div class="err-box" id="registerAuthError"></div>
    </div>
  </div>
</div>
</div>

<!-- JOIN SCREEN -->
<div id="loginScreen" class="screen hidden">
<div class="screen-inner">
  <div class="big-logo">UNO</div>
  <div class="sub-title">Multiplayer</div>
  <div class="card-panel">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:10px 12px;background:rgba(0,0,0,0.25);border-radius:14px;border:1px solid rgba(255,255,255,0.1)">
      <div style="position:relative;flex-shrink:0" onclick="document.getElementById('changePfpInp').click()">
        <div class="avatar-preview" id="profileAvDisp" style="width:48px;height:48px;font-size:24px;cursor:pointer;border:2px solid rgba(255,215,0,0.4)">üë§</div>
        <div style="position:absolute;bottom:-2px;right:-2px;width:18px;height:18px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;pointer-events:none">‚úèÔ∏è</div>
        <input type="file" id="changePfpInp" accept="image/*" style="display:none" onchange="changeProfilePic(this)">
      </div>
      <div style="flex:1">
        <div style="font-family:Nunito,sans-serif;font-weight:900;font-size:16px;color:var(--gold)" id="profileNameDisp">‚Äî</div>
        <div style="font-size:10px;color:rgba(255,255,255,0.35);font-weight:700;margin-top:2px">Tap photo to change</div>
      </div>
      <button onclick="doLogout()" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:5px 10px;font-family:Nunito,sans-serif;font-weight:800;font-size:11px;color:rgba(255,255,255,0.5);cursor:pointer">Logout</button>
    </div>
    <button class="btn-gold" onclick="createRoom()">üÉè Create Room</button>
    <div class="divider">or join existing room</div>
    <label class="field-label">Room Code</label>
    <input class="inp" type="text" id="roomCodeInput" placeholder="e.g. ABC123" maxlength="12" autocomplete="off" spellcheck="false" style="text-transform:uppercase">
    <button class="btn-ghost" onclick="joinRoom()">üîó Join Room</button>
    <div class="err-box" id="loginError"></div>
  </div>
</div>
</div>

<!-- LOBBY -->
<div id="lobbyScreen" class="screen hidden">
<div class="screen-inner">
  <div class="big-logo" style="font-size:clamp(50px,11vw,68px);margin-bottom:6px">UNO</div>
  <div class="card-panel" style="max-width:400px">
    <h2>üè† Game Lobby</h2>
    <div style="text-align:center;font-size:11px;color:rgba(255,255,255,0.4);font-weight:700;margin-bottom:12px">
      Share the link to invite friends <span style="animation:blink 1s infinite;display:inline-block">‚óè</span>
    </div>
    <div class="share-box">
      <span class="share-url" id="shareUrl">‚Äî</span>
      <button class="copy-btn" onclick="copyLink()">üìã Copy</button>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <span style="font-family:Nunito;font-weight:800;font-size:13px;color:rgba(255,255,255,0.55)">Players (<span id="playerCount">1</span>)</span>
      <span style="font-size:11px;color:rgba(255,255,255,0.3);font-weight:700">Code: <span id="roomCodeDisplay" style="color:var(--gold)">‚Äî</span></span>
    </div>
    <ul class="player-list" id="playerList"></ul>
    <div class="settings-row" id="hostSettings" style="display:none">
      <div class="setting-box"><label>Cards each</label><select id="settingCards"><option value="5">5 cards</option><option value="7" selected>7 cards</option><option value="10">10 cards</option></select></div>
      <div class="setting-box"><label>Stacking</label><select id="settingStack"><option value="off">Off</option><option value="on">On (house)</option></select></div>
    </div>
    <div id="hostBotRow" style="display:none;gap:9px;margin-bottom:15px;align-items:center">
      <span style="font-size:11px;color:rgba(255,255,255,0.4);font-weight:700;flex-shrink:0">ü§ñ Add Bot:</span>
      <button onclick="addBotToRoom('easy')"   style="flex:1;background:rgba(30,158,70,0.2);border:1.5px solid rgba(30,158,70,0.35);border-radius:10px;padding:7px 4px;font-family:Nunito,sans-serif;font-weight:900;font-size:11px;color:white;cursor:pointer">Easy</button>
      <button onclick="addBotToRoom('medium')" style="flex:1;background:rgba(1,86,168,0.2);border:1.5px solid rgba(1,86,168,0.35);border-radius:10px;padding:7px 4px;font-family:Nunito,sans-serif;font-weight:900;font-size:11px;color:white;cursor:pointer">Medium</button>
      <button onclick="addBotToRoom('hard')"   style="flex:1;background:rgba(232,25,44,0.2);border:1.5px solid rgba(232,25,44,0.35);border-radius:10px;padding:7px 4px;font-family:Nunito,sans-serif;font-weight:900;font-size:11px;color:white;cursor:pointer">Hard</button>
    </div>
    <button class="btn-gold" id="btnStartGame" onclick="startMultiplayerGame()" disabled>üöÄ Start Game</button>
    <button class="btn-ghost" onclick="leaveLobby()">‚Üê Leave</button>
  </div>
</div>
</div>

<!-- GAME -->
<div id="gameScreen" class="hidden">
  <div class="hdr">
    <div class="logo-sm">UNO</div>
    <div class="dir-label" id="dirLabel">‚ñ∂ Clockwise</div>
  </div>
  <div class="opp-scroll"><div class="opp-row" id="opponentsRow"></div></div>
  <div class="turn-strip" id="turnStrip"></div>
  <div class="center-area">
    <div class="pile-wrap">
      <div class="pile-label">Draw Pile</div>
      <div class="deck-stack" id="deckStack" onclick="playerDraw()">
        <div class="sh"></div><div class="sh"></div>
        <div class="deck-top" id="deckTopEl">
          <img src="assets/card_back.png" alt="back"
               onerror="this.parentNode.style.cssText+='background:linear-gradient(145deg,#1a3a8a,#0d2060);display:flex;align-items:center;justify-content:center;font-family:Nunito,sans-serif;font-weight:900;font-size:13px;color:#e8192c;';this.style.display='none';this.parentNode.textContent='UNO';">
        </div>
      </div>
      <div class="deck-remaining" id="deckRemaining">‚Äî left</div>
    </div>
    <div class="game-mid">
      <div class="color-swatch" id="colorSwatch"></div>
      <div class="color-lbl" id="colorLbl">‚Äî</div>
    </div>
    <div class="pile-wrap">
      <div class="pile-label">Discard</div>
      <div class="discard-pile" id="discardPile"></div>
    </div>
  </div>
  <div class="player-area">
    <div class="your-info">
      <div class="your-name">
        <span id="myAvDisp" style="width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0"></span>
        <span id="myNameDisp">You</span>
      </div>
      <div style="display:flex;align-items:center;gap:7px">
        <span class="your-cnt" id="yourCount">0 cards</span>
        <div id="yourUnoBadge" style="display:none;background:var(--red);color:white;font-family:Nunito,sans-serif;font-weight:900;font-size:10px;padding:2px 7px;border-radius:8px;animation:unoFlash 0.6s ease-in-out infinite alternate">UNO!</div>
      </div>
    </div>
    <div class="turn-bar"><div class="turn-pill" id="turnLabel">‚Äî</div></div>
    <div class="scroll-hint" id="scrollHint"></div>
    <div class="hand-container" id="playerHand"><div class="hand-inner" id="handInner"></div></div>
  </div>
  <div class="action-bar">
    <button class="btn-act" id="btnDraw" onclick="playerDraw()" disabled>
      <img src="assets/btn_draw.png" alt="Draw"
           onerror="this.style.display='none';this.parentNode.innerHTML='<span class=btn-act-fallback>üÉè Draw</span>'">
    </button>
    <button class="btn-act" id="btnUno" onclick="callUno()" disabled>
      <img src="assets/btn_uno.png" alt="UNO!"
           onerror="this.style.display='none';this.parentNode.innerHTML='<span class=btn-act-fallback>üî¥ UNO!</span>'">
    </button>
    <button class="btn-act" id="btnChat" onclick="toggleChat()">üí¨</button>
  </div>
</div>

<div class="connecting" id="connectingIndicator"><div class="spin"></div><span id="connectingText">Connecting‚Ä¶</span></div>
<div class="action-banner" id="actionBanner"></div>
<div class="toast" id="toast"></div>

<!-- Color picker -->
<div class="overlay" id="colorModal" style="display:none">
  <div class="modal">
    <div class="modal-ttl">üé® Choose a Color</div>
    <div class="modal-sub">Pick the active color for your wild</div>
    <div class="color-grid">
      <button class="color-btn cb-r" onclick="pickColor('red')">üî¥ Red</button>
      <button class="color-btn cb-y" onclick="pickColor('yellow')">üü° Yellow</button>
      <button class="color-btn cb-g" onclick="pickColor('green')">üü¢ Green</button>
      <button class="color-btn cb-b" onclick="pickColor('blue')">üîµ Blue</button>
    </div>
  </div>
</div>

<!-- Win/lose -->
<div class="overlay" id="winModal" style="display:none">
  <div class="modal">
    <div class="win-emoji" id="winEmoji">üéâ</div>
    <div class="win-ttl" id="winTtl">You Win!</div>
    <div class="win-sub" id="winSub"></div>
    <ul class="score-list" id="scoreList"></ul>
    <div class="win-btns">
      <button class="btn-restart" id="btnPlayAgain" onclick="requestRematch()">üîÑ Play Again</button>
      <button class="btn-leave-sm" onclick="leaveLobby()">üö™ Leave</button>
    </div>
    <div style="margin-top:10px;text-align:center">
      <button class="replay-btn" onclick="openReplay()" style="font-size:12px;padding:8px 18px">üé¨ Watch Replay</button>
    </div>
  </div>
</div>

<!-- Chat -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-hdr">üí¨ Chat <button class="chat-close" onclick="toggleChat()">‚úï</button></div>
  <div class="emoji-bar">
    <button class="e-btn" onclick="sendReaction('üòÇ')">üòÇ</button>
    <button class="e-btn" onclick="sendReaction('üî•')">üî•</button>
    <button class="e-btn" onclick="sendReaction('üò±')">üò±</button>
    <button class="e-btn" onclick="sendReaction('üéâ')">üéâ</button>
    <button class="e-btn" onclick="sendReaction('üò§')">üò§</button>
    <button class="e-btn" onclick="sendReaction('üëë')">üëë</button>
    <button class="e-btn" onclick="sendReaction('üíÄ')">üíÄ</button>
    <button class="e-btn" onclick="sendReaction('ü§£')">ü§£</button>
  </div>
  <div class="chat-msgs" id="chatMsgs"></div>
  <div class="chat-in">
    <input type="text" id="chatInput" placeholder="Say something‚Ä¶" maxlength="80" onkeydown="if(event.key==='Enter')sendChat()">
    <button class="chat-send" onclick="sendChat()">Send</button>
  </div>
</div>

<!-- XP Bar -->
<div class="xp-bar-wrap" id="xpBarWrap">
  <div class="xp-bar-inner">
    <div class="xp-level-badge" id="xpLevelBadge">Lv.1</div>
    <div class="xp-bar-track"><div class="xp-bar-fill" id="xpBarFill" style="width:0%"></div></div>
    <span style="font-size:10px;color:rgba(255,255,255,0.35);font-family:'Nunito',sans-serif;font-weight:700;white-space:nowrap" id="xpText">0 XP</span>
  </div>
</div>

<!-- Voice Chat Button -->
<button class="vc-btn" id="vcBtn" onclick="toggleVoice()" title="Voice Chat">üéôÔ∏è</button>
<div class="vc-indicators" id="vcIndicators"></div>

<!-- Leaderboard Button -->
<button class="lb-btn" onclick="showLeaderboard()" title="Leaderboard">üèÜ</button>

<!-- Fullscreen Button -->
<button class="fs-btn" onclick="toggleFS()">‚õ∂</button>

<!-- Leaderboard Panel -->
<div class="lb-panel" id="lbPanel" style="display:none">
  <div class="lb-modal">
    <h2>üèÜ Leaderboard</h2>
    <div class="lb-subtitle" id="lbSubtitle">All-time rankings</div>
    <ul class="lb-list" id="lbList"></ul>
    <button class="lb-close" onclick="document.getElementById('lbPanel').style.display='none'">‚úï Close</button>
  </div>
</div>

<!-- Replay Panel -->
<div class="replay-panel" id="replayPanel" style="display:none">
  <div class="replay-modal">
    <h2>üé¨ Game Replay</h2>
    <div class="replay-timeline" id="replayTimeline"></div>
    <button class="lb-close" onclick="document.getElementById('replayPanel').style.display='none'">‚úï Close</button>
  </div>
</div>

<script>
// ================================================================
//  SOCKET.IO
// ================================================================
const SERVER_URL = 'https://uno-q4qa.onrender.com';
const socket = io(SERVER_URL, {
  transports: ['polling', 'websocket'],
  upgrade: true,
  reconnection: true,
  reconnectionAttempts: Infinity,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000,
  timeout: 20000,
  withCredentials: false,
});
socket.on('connect',       () => { hideConn(); mySocketId = socket.id; });
socket.on('disconnect',    () => showConn('Reconnecting‚Ä¶'));
socket.on('connect_error', () => showConn('Connection lost ‚Äî retrying‚Ä¶'));

// ================================================================
//  SOUNDS ‚Äî original asset files
// ================================================================
const SND = {};
function loadSnd(k, src, loop, vol) {
  const a = new Audio(src); a.preload = 'auto';
  if (loop) a.loop = true; a.volume = vol || 1; SND[k] = a;
}
loadSnd('theme', 'assets/Theme_song.mp3', true,  0.35);
loadSnd('last',  'assets/Last_card.mp3',  true,  0.95);
loadSnd('touch', 'assets/Card_touch.mp3', false, 0.75);
loadSnd('play',  'assets/Card_play.mp3',  false, 1.0);
loadSnd('draw',  'assets/Draw.mp3',       false, 0.85);
loadSnd('uno',   'assets/Uno.mp3',        false, 1.0);
loadSnd('win',   'assets/Win.mp3',        false, 1.0);
loadSnd('lose',  'assets/Lose.mp3',       false, 1.0);

let themeOn = false, tensionOn = false;
function sfx(k) {
  try { const s = SND[k]; if (!s) return; const c = s.cloneNode(); c.volume = s.volume; c.play().catch(() => {}); } catch(e) {}
}
function fadeTo(a, t, ms) {
  const st = a.volume, df = t - st, N = 25; let i = 0;
  const iv = setInterval(() => { i++; a.volume = Math.max(0, Math.min(1, st + df*(i/N))); if (i >= N) clearInterval(iv); }, ms/N);
}
function startTheme() {
  if (themeOn) return; themeOn = true;
  const t = SND['theme']; t.currentTime = 0; t.volume = 0;
  t.play().then(() => fadeTo(t, 0.35, 1200)).catch(() => {});
}
function stopMusic() {
  fadeTo(SND['theme'], 0, 500); setTimeout(() => SND['theme'].pause(), 550);
  if (tensionOn) { fadeTo(SND['last'], 0, 400); setTimeout(() => { SND['last'].pause(); SND['last'].currentTime = 0; }, 450); tensionOn = false; }
  themeOn = false;
}
function checkTension() {
  const anyone1 = Object.values(handCounts).some(c => c === 1) || myHand.length === 1;
  if (anyone1 && !tensionOn && themeOn) {
    tensionOn = true; fadeTo(SND['theme'], 0.08, 700);
    SND['last'].currentTime = 0; SND['last'].play().catch(() => {}); fadeTo(SND['last'], 0.55, 700);
    document.body.classList.add('bg-tension');
  } else if (!anyone1 && tensionOn) {
    tensionOn = false; fadeTo(SND['last'], 0, 500);
    setTimeout(() => { SND['last'].pause(); SND['last'].currentTime = 0; }, 550);
    fadeTo(SND['theme'], 0.35, 700);
    document.body.classList.remove('bg-tension');
    setDynamicBg(currentColor);
  }
}

// ================================================================
//  FULLSCREEN
// ================================================================
function toggleFS() {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
  else document.exitFullscreen();
}

// ================================================================
//  CARD HELPERS ‚Äî use asset images, fall back to colored div
// ================================================================
const FB   = { red:'#e8192c', yellow:'#f5d400', green:'#1e9e46', blue:'#0156a8', wild:'#333' };
const SYM  = { skip:'‚äò', reverse:'‚Ü∫', draw2:'+2', wild:'‚ú¶', wild_draw4:'+4' };
const CMETA = {
  red:    { hex:'#e8192c', glow:'rgba(232,25,44,0.6)',  lbl:'Red' },
  yellow: { hex:'#f5d400', glow:'rgba(245,212,0,0.6)',  lbl:'Yellow' },
  green:  { hex:'#1e9e46', glow:'rgba(30,158,70,0.6)',  lbl:'Green' },
  blue:   { hex:'#0156a8', glow:'rgba(1,86,168,0.6)',   lbl:'Blue' },
};

function cardFile(c) {
  if (c.value === 'wild') return 'assets/wild.png';
  if (c.value === 'wild_draw4') return 'assets/wild_draw4.png';
  return `assets/${c.color}_${c.value}.png`;
}

function makeImg(card) {
  const w = document.createElement('div');
  w.style.cssText = 'width:100%;height:100%;border-radius:inherit;overflow:hidden;';
  const img = document.createElement('img');
  img.src = cardFile(card);
  img.alt = `${card.color} ${card.value}`;
  img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block;border-radius:inherit;pointer-events:none;';
  img.onerror = () => {
    img.remove();
    const fb = document.createElement('div');
    fb.style.cssText = `width:100%;height:100%;background:${FB[card.color]||'#333'};border-radius:inherit;display:flex;align-items:center;justify-content:center;font-family:Nunito,sans-serif;font-weight:900;font-size:clamp(12px,3vw,20px);color:white;`;
    fb.textContent = SYM[card.value] || card.value;
    w.appendChild(fb);
  };
  w.appendChild(img); return w;
}

function makeBack() {
  const w = document.createElement('div');
  w.style.cssText = 'width:100%;height:100%;border-radius:inherit;overflow:hidden;';
  const img = document.createElement('img');
  img.src = 'assets/card_back.png';
  img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block;border-radius:inherit;pointer-events:none;';
  img.onerror = () => {
    img.remove();
    const fb = document.createElement('div');
    fb.style.cssText = 'width:100%;height:100%;background:linear-gradient(145deg,#1a3a8a,#0d2060);border-radius:inherit;display:flex;align-items:center;justify-content:center;font-family:Nunito,sans-serif;font-weight:900;font-size:16px;color:#e8192c;';
    fb.textContent = 'UNO'; w.appendChild(fb);
  };
  w.appendChild(img); return w;
}

let mySocketId = null, myName = 'Player', myAvatar = 'üéÆ', myUID = null, isHost = false;
let currentRoomCode = null, lobbyPlayers = [], gameSettings = { cards:7, stacking:false };
let myHand = [], handCounts = {}, turnOrder = [], currentTurnIdx = 0, direction = 1;
let currentColor = '', currentValue = '', discardTop = null, deckCount = 0;
let finishOrder = [], gameActive = false, unoFlags = {};
let selectedCard = null, pendingWild = null, rematchVotes = new Set();

// ================================================================
//  XP SYSTEM
// ================================================================
const XP_PER_LEVEL = 120;
function getXP() { try { return JSON.parse(localStorage.getItem('uno_xp') || '{"xp":0,"level":1}'); } catch(e){ return {xp:0,level:1}; } }
function saveXP(d){ try { localStorage.setItem('uno_xp', JSON.stringify(d)); } catch(e){} }
function addXP(amount, reason) {
  const d = getXP();
  d.xp += amount;
  while (d.xp >= XP_PER_LEVEL) { d.xp -= XP_PER_LEVEL; d.level++; showLevelUp(d.level); }
  saveXP(d); updateXPBar();
  const pop = document.createElement('div');
  pop.className = 'xp-gain-pop';
  pop.textContent = `+${amount} XP`;
  pop.style.cssText = `left:${30+Math.random()*40}%;top:${40+Math.random()*20}%;`;
  document.body.appendChild(pop);
  setTimeout(() => pop.remove(), 1500);
}
function updateXPBar() {
  const d = getXP();
  const pct = (d.xp / XP_PER_LEVEL) * 100;
  document.getElementById('xpLevelBadge').textContent = `Lv.${d.level}`;
  document.getElementById('xpBarFill').style.width = pct + '%';
  document.getElementById('xpText').textContent = `${d.xp}/${XP_PER_LEVEL}`;
}
function showLevelUp(lvl) {
  const b = document.createElement('div');
  b.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:900;text-align:center;animation:modalIn 0.4s ease forwards;pointer-events:none;';
  b.innerHTML = `<div style="font-family:Nunito,sans-serif;font-weight:900;font-size:32px;color:var(--gold);text-shadow:0 0 30px rgba(255,215,0,0.8)">‚¨ÜÔ∏è LEVEL UP!</div><div style="font-family:Nunito,sans-serif;font-weight:800;font-size:18px;color:white;margin-top:4px">You reached Level ${lvl}</div>`;
  document.body.appendChild(b);
  setTimeout(() => b.remove(), 2800);
}
function showXPBar(show) {
  document.getElementById('xpBarWrap').classList.toggle('show', show);
  if (show) updateXPBar();
}

// ================================================================
//  GLOBAL LEADERBOARD (localStorage cross-session, simulated cross-device)
// ================================================================
function getLBData() { try { return JSON.parse(localStorage.getItem('uno_leaderboard') || '[]'); } catch(e){ return []; } }
function saveLBData(d){ try { localStorage.setItem('uno_leaderboard', JSON.stringify(d)); } catch(e){} }
function recordWin(name, uid) {
  const lb = getLBData();
  let entry = lb.find(e => e.uid === uid);
  if (!entry) { entry = { uid, name, wins:0, plays:0, xpLevel:1 }; lb.push(entry); }
  entry.wins++; entry.plays++; entry.name = name;
  entry.xpLevel = getXP().level;
  lb.sort((a,b) => b.wins - a.wins);
  saveLBData(lb);
}
function recordPlay(uid, name) {
  const lb = getLBData();
  let entry = lb.find(e => e.uid === uid);
  if (!entry) { entry = { uid, name, wins:0, plays:0, xpLevel:1 }; lb.push(entry); }
  entry.plays++; entry.name = name; entry.xpLevel = getXP().level;
  saveLBData(lb);
}
function showLeaderboard() {
  const lb = getLBData();
  if (!lb.length) {
    toast('No leaderboard data yet ‚Äî play some games! üéÆ'); return;
  }
  const medals = ['ü•á','ü•à','ü•â'];
  const list = document.getElementById('lbList'); list.innerHTML = '';
  lb.slice(0,15).forEach((e,i) => {
    const li = document.createElement('li');
    li.className = 'lb-item' + (e.uid === myUID ? ' me' : '');
    const wr = e.plays > 0 ? Math.round((e.wins/e.plays)*100) : 0;
    li.innerHTML = `<span class="lb-rank">${medals[i]||'#'+(i+1)}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.name}</span><span style="font-size:10px;color:rgba(255,255,255,0.35);margin-right:6px">Lv.${e.xpLevel||1}</span><span class="lb-stat"><span class="lb-wins">${e.wins}W</span> ¬∑ ${wr}%</span>`;
    list.appendChild(li);
  });
  const myRank = lb.findIndex(e => e.uid === myUID);
  document.getElementById('lbSubtitle').textContent = myRank >= 0 ? `Your rank: #${myRank+1} of ${lb.length}` : 'All-time rankings';
  document.getElementById('lbPanel').style.display = 'flex';
}

// ================================================================
//  REPLAY SYSTEM
// ================================================================
let replayLog = [];
let replayGameStart = 0;
function replayRecord(icon, text, extraClass) {
  const elapsed = replayGameStart > 0 ? Math.floor((Date.now()-replayGameStart)/1000) : 0;
  replayLog.push({ icon, text, time: elapsed, extraClass: extraClass||'' });
}
function openReplay() {
  const tl = document.getElementById('replayTimeline'); tl.innerHTML = '';
  if (!replayLog.length) { toast('No replay data yet ‚Äî finish a game first!'); return; }
  replayLog.forEach(e => {
    const d = document.createElement('div');
    d.className = 'replay-event ' + e.extraClass;
    const mm = String(Math.floor(e.time/60)).padStart(2,'0');
    const ss = String(e.time%60).padStart(2,'0');
    d.innerHTML = `<span class="re-icon">${e.icon}</span><span style="flex:1">${e.text}</span><span class="re-time">${mm}:${ss}</span>`;
    tl.appendChild(d);
  });
  tl.scrollTop = tl.scrollHeight;
  document.getElementById('replayPanel').style.display = 'flex';
}

// ================================================================
//  PARTICLE EFFECTS
// ================================================================
const CARD_COLORS_HEX = {
  red:'#e8192c', yellow:'#f5d400', green:'#1e9e46', blue:'#0156a8', wild:'#9333ea'
};
function spawnCardParticles(card, x, y) {
  const col = CARD_COLORS_HEX[card.color] || '#fff';
  const isSpecial = ['skip','reverse','draw2','wild','wild_draw4'].includes(card.value);
  const count = isSpecial ? 22 : 10;
  for (let i = 0; i < count; i++) {
    const p = document.createElement('div');
    const angle = (Math.PI * 2 / count) * i + (Math.random()-0.5)*0.4;
    const dist  = 40 + Math.random() * 80;
    const tx = Math.cos(angle) * dist;
    const ty = Math.sin(angle) * dist - 30;
    const sz = 5 + Math.random() * 8;
    p.className = 'particle';
    p.style.cssText = `left:${x-sz/2}px;top:${y-sz/2}px;width:${sz}px;height:${sz}px;background:${col};--tx:${tx}px;--ty:${ty}px;animation-duration:${0.5+Math.random()*0.5}s;`;
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 1100);
  }
  if (isSpecial) {
    const icons = { skip:'‚äò', reverse:'‚Ü∫', draw2:'üí•', wild:'‚ú®', wild_draw4:'üí´' };
    const star = document.createElement('div');
    const stx = (Math.random()-0.5)*60, sty = -50-Math.random()*30;
    star.className = 'particle-star';
    star.style.cssText = `left:${x-15}px;top:${y-15}px;--tx:${stx}px;--ty:${sty}px;animation-duration:0.9s;`;
    star.textContent = icons[card.value] || '‚ú®';
    document.body.appendChild(star);
    setTimeout(() => star.remove(), 1000);
  }
}

function spawn3DCardFlip(card, fromEl) {
  const rect = fromEl ? fromEl.getBoundingClientRect() : { left: window.innerWidth/2-31, top: window.innerHeight/2-48 };
  const flip = document.createElement('div');
  flip.className = 'card-flip';
  flip.style.cssText = `left:${rect.left}px;top:${rect.top}px;`;
  const col = CARD_COLORS_HEX[card.color] || '#333';
  const sym = { skip:'‚äò', reverse:'‚Ü∫', draw2:'+2', wild:'‚ú¶', wild_draw4:'+4' };
  flip.innerHTML = `<div class="card-flip-face card-flip-front" style="background:linear-gradient(145deg,${col},${col}aa)">${sym[card.value]||card.value}</div><div class="card-flip-face card-flip-back">UNO</div>`;
  document.body.appendChild(flip);
  setTimeout(() => flip.remove(), 600);
  // Also spawn particles at card position
  setTimeout(() => spawnCardParticles(card, rect.left+31, rect.top+48), 220);
}

// ================================================================
//  DYNAMIC BACKGROUND
// ================================================================
function setDynamicBg(color) {
  document.body.className = document.body.className.replace(/bg-\S+/g, '').trim();
  if (color) document.body.classList.add('bg-' + color);
}

// ================================================================
//  VOICE CHAT (WebRTC)
// ================================================================
let vcActive = false, vcStream = null;
let vcPeers = {}, vcSpeakTimers = {};
let vcSocket = null; // reuse main socket for signaling
const VC_ROOM_PREFIX = 'vc_';

function toggleVoice() {
  if (vcActive) { stopVoice(); }
  else { startVoice(); }
}

async function startVoice() {
  try {
    vcStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    vcActive = true;
    document.getElementById('vcBtn').classList.add('active');
    document.getElementById('vcBtn').textContent = 'üéôÔ∏è';
    toast('üéôÔ∏è Mic on ‚Äî others can hear you!');
    setupVAD();
    // Notify room via socket that we joined voice
    socket.emit('vc_join', { name: myName, uid: myUID });
  } catch(err) {
    toast('Mic access denied ‚Äî check browser settings üéôÔ∏è');
  }
}

function stopVoice() {
  if (vcStream) { vcStream.getTracks().forEach(t => t.stop()); vcStream = null; }
  Object.values(vcPeers).forEach(pc => { try { pc.close(); } catch(e){} });
  vcPeers = {};
  vcActive = false;
  document.getElementById('vcBtn').classList.remove('active','speaking');
  document.getElementById('vcBtn').textContent = 'üéôÔ∏è';
  document.getElementById('vcIndicators').innerHTML = '';
  socket.emit('vc_leave');
  toast('üîá Mic off');
}

function setupVAD() {
  if (!vcStream) return;
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const src = ctx.createMediaStreamSource(vcStream);
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 256;
    src.connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);
    let speaking = false;
    setInterval(() => {
      if (!vcActive) return;
      analyser.getByteFrequencyData(data);
      const vol = data.reduce((a,b) => a+b, 0) / data.length;
      const isSpeaking = vol > 20;
      if (isSpeaking !== speaking) {
        speaking = isSpeaking;
        document.getElementById('vcBtn').classList.toggle('speaking', speaking);
        socket.emit('vc_speaking', { speaking, name: myName });
      }
    }, 150);
  } catch(e) {}
}

// VC signaling via socket
function createVCPeer(targetId, initiator) {
  if (!vcStream) return null;
  try {
    const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    vcStream.getTracks().forEach(t => pc.addTrack(t, vcStream));
    pc.ontrack = e => {
      const audio = new Audio();
      audio.srcObject = e.streams[0];
      audio.autoplay = true;
      document.body.appendChild(audio);
      pc._audioEl = audio;
    };
    pc.onicecandidate = e => {
      if (e.candidate) socket.emit('vc_ice', { to: targetId, candidate: e.candidate });
    };
    pc.onconnectionstatechange = () => {
      if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
        if (pc._audioEl) pc._audioEl.remove();
        delete vcPeers[targetId];
      }
    };
    if (initiator) {
      pc.createOffer().then(offer => {
        pc.setLocalDescription(offer);
        socket.emit('vc_offer', { to: targetId, offer });
      });
    }
    vcPeers[targetId] = pc;
    return pc;
  } catch(e) { return null; }
}

function updateVCIndicator(id, name, speaking) {
  const wrap = document.getElementById('vcIndicators');
  let pip = document.getElementById('vc_' + id);
  if (!pip) {
    pip = document.createElement('div');
    pip.className = 'vc-pip';
    pip.id = 'vc_' + id;
    pip.innerHTML = `<div class="vc-mic-dot"></div><span>${name}</span>`;
    wrap.appendChild(pip);
  }
  pip.classList.toggle('speaking', speaking);
  clearTimeout(vcSpeakTimers[id]);
  if (speaking) { vcSpeakTimers[id] = setTimeout(() => pip.classList.remove('speaking'), 1200); }
}

// VC socket events
socket.on('vc_joined',    ({ id, name }) => { if (vcActive && id !== socket.id) createVCPeer(id, true); toast(`${name} joined voice üéôÔ∏è`); });
socket.on('vc_left',      ({ id, name }) => {
  if (vcPeers[id]) { try { vcPeers[id].close(); if (vcPeers[id]._audioEl) vcPeers[id]._audioEl.remove(); } catch(e){} delete vcPeers[id]; }
  const pip = document.getElementById('vc_'+id); if (pip) pip.remove();
  toast(`${name} left voice üîá`);
});
socket.on('vc_offer',     async ({ from, offer }) => {
  const pc = createVCPeer(from, false) || vcPeers[from];
  if (!pc) return;
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  socket.emit('vc_answer', { to: from, answer });
});
socket.on('vc_answer',    async ({ from, answer }) => {
  const pc = vcPeers[from]; if (!pc) return;
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
});
socket.on('vc_ice',       async ({ from, candidate }) => {
  const pc = vcPeers[from]; if (!pc) return;
  try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch(e) {}
});
socket.on('vc_speaking',  ({ id, name, speaking }) => updateVCIndicator(id, name, speaking));

// ================================================================
//  AI BOT ‚Äî client helper (actual logic runs server-side)
// ================================================================
function startBotMode() {
  // Called by add_bot buttons in lobby ‚Äî handled by addBotToRoom()
  toast('ü§ñ Use the Easy/Medium/Hard buttons in the lobby to add AI bots!');
}

// ================================================================
//  SOCKET EVENTS
// ================================================================
socket.on('error_msg',       ({ msg }) => { hideConn(); showErr(msg); toast(msg); });
socket.on('room_created',    ({ code, players, settings }) => {
  hideConn(); currentRoomCode = code; isHost = true;
  lobbyPlayers = players; gameSettings = settings; showLobby();
});
socket.on('lobby_state',     ({ players, settings, code }) => {
  hideConn(); currentRoomCode = code; isHost = false;
  lobbyPlayers = players; gameSettings = settings; showLobby();
});
socket.on('player_joined',   ({ player }) => {
  if (!lobbyPlayers.find(p => p.id === player.id)) lobbyPlayers.push(player);
  sfx('touch'); updateLobbyUI(); addChat(null, `${player.name} joined üëã`, true);
});
socket.on('player_left',     ({ id }) => {
  const name = getName(id);
  lobbyPlayers = lobbyPlayers.filter(p => p.id !== id);
  updateLobbyUI();
  if (gameActive) { toast(`${name} disconnected!`); applyLeave(id); }
  else addChat(null, `${name} left`, true);
});
socket.on('player_rejoined', ({ player }) => {
  const ex = lobbyPlayers.find(p => p.uid === player.uid);
  if (ex) ex.id = player.id; else lobbyPlayers.push(player);
  toast(`${player.name} reconnected üîÑ`);
});
socket.on('new_host',        ({ id }) => {
  lobbyPlayers.forEach(p => p.isHost = p.id === id);
  if (id === socket.id) { isHost = true; toast('You are now the host üëë'); }
  updateLobbyUI();
});
socket.on('settings_updated', s => { gameSettings = s; });
socket.on('game_start',      data => receiveStart(data));
socket.on('game_rejoin',     data => receiveRejoin(data));
socket.on('game_state',      data => applyState(data));
socket.on('your_hand',       ({ hand }) => { myHand = hand; renderHand(); });
socket.on('action_banner',   ({ msg }) => { showBanner(msg); replayRecord('üì¢', msg); });
socket.on('uno_called',      ({ id }) => { showBanner(`${getName(id)} UNO! üéâ`); sfx('uno'); replayRecord('üî¥', `${getName(id)} called UNO!`); });
socket.on('chat',            ({ name, text, system }) => addChat(name, text, system));
socket.on('reaction',        ({ emoji, name }) => floatEmoji(emoji, name));
socket.on('rematch_count',   ({ votes, total }) => {
  rematchVotes = new Set(votes); updateRematchBtn();
  toast(`Play again votes: ${votes.length}/${total}`);
});
socket.on('rematch_go',      () => {
  document.getElementById('winModal').style.display = 'none';
  rematchVotes = new Set(); toast('Starting new game! üéÆ');
});
socket.on('game_over',       ({ finishOrder: fo }) => {
  finishOrder = fo; gameActive = false; stopMusic();
  const iWon = fo[0] === socket.id;
  sfx(iWon ? 'win' : 'lose');
  setDynamicBg(iWon ? 'win' : '');
  // XP + leaderboard
  if (iWon) {
    addXP(50, 'win!');
    recordWin(myName, myUID);
    replayRecord('üèÜ', `${myName} won the game!`, 're-win');
  } else {
    const pos = fo.indexOf(socket.id) + 1;
    addXP(Math.max(5, 30 - (pos-1)*8), 'participation');
    replayRecord('üíÄ', `Game over ‚Äî you finished #${pos}`);
  }
  showXPBar(false);
  showGameOver(iWon);
});

// ================================================================
//  ROOM ACTIONS
// ================================================================
function createRoom() {
  if (!myUID) { toast('Please log in first'); return; }
  hideErr(); showConn('Creating room‚Ä¶');
  socket.emit('create_room', { name:myName, avatar:myAvatar, uid:myUID });
}
function joinRoom() {
  if (!myUID) { toast('Please log in first'); return; }
  const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
  if (!code) { showErr('Please enter a room code!'); return; }
  hideErr(); showConn('Joining room‚Ä¶');
  socket.emit('join_room', { code, name:myName, avatar:myAvatar, uid:myUID });
}
function startMultiplayerGame() {
  if (!isHost) return;
  const cards    = parseInt(document.getElementById('settingCards').value);
  const stacking = document.getElementById('settingStack').value === 'on';
  socket.emit('update_settings', { cards, stacking });
  socket.emit('start_game');
}
function leaveLobby() {
  socket.emit('leave_room');
  gameActive = false; myHand = []; handCounts = {}; selectedCard = null; lobbyPlayers = [];
  document.getElementById('winModal').style.display   = 'none';
  document.getElementById('colorModal').style.display = 'none';
  document.getElementById('gameScreen').classList.add('hidden');
  document.getElementById('lobbyScreen').classList.add('hidden');
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  showXPBar(false);
  setDynamicBg('');
  if (vcActive) stopVoice();
  stopMusic();
}

// ================================================================
//  GAME RECEIVE
// ================================================================
function receiveStart(data) {
  myHand = data.hand; turnOrder = data.turnOrder; currentTurnIdx = data.currentTurnIdx;
  direction = data.direction; currentColor = data.currentColor; currentValue = data.currentValue;
  discardTop = data.discardTop; deckCount = data.deckCount; handCounts = data.handCounts || {};
  finishOrder = []; gameActive = true; unoFlags = {};
  lobbyPlayers = data.players || lobbyPlayers;
  // Replay + XP init
  replayLog = []; replayGameStart = Date.now();
  replayRecord('üéÆ', 'Game started!', '');
  recordPlay(myUID, myName);
  showXPBar(true);
  setDynamicBg(data.currentColor || 'green');
  showGame(); renderGame(); startTheme();
  addChat(null, 'Game started! Good luck! üÉè', true);
}
function receiveRejoin(data) {
  myHand = data.hand; turnOrder = data.turnOrder; currentTurnIdx = data.currentTurnIdx;
  direction = data.direction; currentColor = data.currentColor; currentValue = data.currentValue;
  discardTop = data.discardTop; deckCount = data.deckCount; handCounts = data.handCounts || {};
  gameSettings = data.settings || gameSettings; lobbyPlayers = data.players || lobbyPlayers;
  finishOrder = []; gameActive = true;
  showGame(); renderGame(); startTheme(); toast('Reconnected! üîÑ');
}
function applyState(data) {
  const prevColor = currentColor;
  currentTurnIdx = data.currentTurnIdx; direction = data.direction;
  currentColor   = data.currentColor;   currentValue = data.currentValue;
  if (data.discardTop  !== undefined) discardTop  = data.discardTop;
  if (data.deckCount   !== undefined) deckCount   = data.deckCount;
  if (data.turnOrder)   turnOrder   = data.turnOrder;
  if (data.finishOrder) finishOrder = data.finishOrder;
  if (data.unoFlags)    unoFlags    = data.unoFlags;
  if (data.handCounts)  handCounts  = data.handCounts;
  // Dynamic background on color change
  if (currentColor !== prevColor) setDynamicBg(currentColor);
  renderGame(); checkTension();
}
function applyLeave(id) {
  const ti = turnOrder.indexOf(id);
  if (ti !== -1) {
    turnOrder.splice(ti, 1);
    if (ti < currentTurnIdx) currentTurnIdx--;
    else if (currentTurnIdx >= turnOrder.length) currentTurnIdx = 0;
  }
  delete handCounts[id]; renderGame();
}

// ================================================================
//  PLAYER ACTIONS
// ================================================================
function isMyTurn() { return gameActive && turnOrder[currentTurnIdx] === socket.id; }
function canPlay(card) { return card.color === 'wild' || card.color === currentColor || card.value === currentValue; }

function onCardTap(card, el) {
  if (!isMyTurn()) { toast('Not your turn!'); return; }
  if (!canPlay(card)) {
    sfx('touch'); toast("Can't play that card!");
    el.animate([
      { transform:'translateX(-6px) translateY(-22px) scale(1.07)' },
      { transform:'translateX(6px)  translateY(-22px) scale(1.07)' },
      { transform:'translateX(-4px) translateY(-22px) scale(1.07)' },
      { transform:'translateX(4px)  translateY(-22px) scale(1.07)' },
      { transform:'translateY(-22px) scale(1.07)' }
    ], { duration:280 });
    return;
  }
  if (selectedCard === card) {
    sfx('play'); el.classList.remove('selected'); selectedCard = null;
    if (card.value === 'wild' || card.value === 'wild_draw4') {
      pendingWild = card; document.getElementById('colorModal').style.display = 'flex';
    } else {
      // 3D flip + particles
      spawn3DCardFlip(card, el);
      socket.emit('play_card', { card, chosenColor: null });
      const i = myHand.findIndex(c => c.color === card.color && c.value === card.value);
      if (i !== -1) myHand.splice(i, 1); renderHand();
      const dp = document.getElementById('discardPile');
      dp.classList.add('pop-in'); setTimeout(() => dp.classList.remove('pop-in'), 320);
      // Replay log
      replayRecord('üÉè', `You played ${card.color} ${card.value}`);
      // XP for playing a card
      const xpAmt = ['skip','reverse','draw2','wild','wild_draw4'].includes(card.value) ? 5 : 2;
      addXP(xpAmt, 'card played');
    }
  } else {
    sfx('touch'); selectedCard = card; renderHand();
  }
}

function pickColor(color) {
  document.getElementById('colorModal').style.display = 'none';
  if (!pendingWild) return;
  const c = pendingWild; pendingWild = null;
  // 3D flip + particles at discard pile position
  const dp = document.getElementById('discardPile');
  spawn3DCardFlip(c, dp);
  socket.emit('play_card', { card:c, chosenColor:color });
  const i = myHand.findIndex(h => h.color === c.color && h.value === c.value);
  if (i !== -1) myHand.splice(i, 1); renderHand();
  dp.classList.add('pop-in'); setTimeout(() => dp.classList.remove('pop-in'), 320);
  // Replay + XP
  replayRecord('‚ú®', `You played ${c.value} ‚Üí chose ${color}`);
  addXP(8, 'wild played');
  setDynamicBg(color);
}

function playerDraw() {
  if (!isMyTurn()) return;
  sfx('draw'); socket.emit('draw_card'); selectedCard = null;
  replayRecord('üÉè', 'You drew a card');
  addXP(1, 'draw');
}

function callUno() {
  if (!gameActive || myHand.length !== 2) return;
  sfx('uno'); toast('UNO! üéâ'); socket.emit('call_uno');
  addXP(15, 'UNO called');
  replayRecord('üî¥', 'You called UNO!');
}

// ================================================================
//  CHAT
// ================================================================
let chatOpen = false;
function toggleChat() {
  chatOpen = !chatOpen;
  document.getElementById('chatPanel').classList.toggle('open', chatOpen);
  if (chatOpen) document.getElementById('chatInput').focus();
}
function sendChat() {
  const inp = document.getElementById('chatInput'), text = inp.value.trim();
  if (!text) return; inp.value = '';
  addChat(myName, text, false);
  socket.emit('chat', { name:myName, text });
}
function addChat(name, text, sys) {
  const c = document.getElementById('chatMsgs'), d = document.createElement('div');
  d.className = 'chat-msg' + (sys ? ' sys' : '') + (name === myName ? ' mine' : '');
  if (name) { const n = document.createElement('div'); n.className = 'mn'; n.textContent = name; d.appendChild(n); }
  const t = document.createElement('div'); t.className = 'mt'; t.textContent = text; d.appendChild(t);
  c.appendChild(d); c.scrollTop = c.scrollHeight;
}
function sendReaction(emoji) { floatEmoji(emoji, myName); socket.emit('reaction', { emoji, name:myName }); }
function floatEmoji(emoji, from) {
  const e = document.createElement('div'); e.className = 'float-emoji'; e.textContent = emoji;
  e.style.left = (20 + Math.random()*60) + 'vw'; e.style.bottom = '120px';
  document.body.appendChild(e); setTimeout(() => e.remove(), 2300);
}

// ================================================================
//  LOBBY UI
// ================================================================
function showLobby() {
  ['authScreen','loginScreen','gameScreen'].forEach(id => document.getElementById(id).classList.add('hidden'));
  document.getElementById('lobbyScreen').classList.remove('hidden');
  updateLobbyUI();
}
function updateLobbyUI() {
  const code = currentRoomCode || '‚Äî';
  document.getElementById('roomCodeDisplay').textContent = code;
  const url = `${window.location.href.split('?')[0]}?room=${code}`;
  document.getElementById('shareUrl').textContent = url;
  const list = document.getElementById('playerList'); list.innerHTML = '';
  for (const p of lobbyPlayers) {
    const li = document.createElement('li');
    const avHtml = p.avatar && p.avatar.startsWith('data:')
      ? `<div style="width:28px;height:28px;border-radius:50%;overflow:hidden;flex-shrink:0"><img src="${p.avatar}" style="width:100%;height:100%;object-fit:cover"></div>`
      : `<span style="font-size:18px">${p.avatar || 'üéÆ'}</span>`;
    const botBadge = p.isBot ? '<span class="ai-badge">AI</span>' : '';
    li.innerHTML = `${avHtml}<span>${p.name}</span>${botBadge}${p.isHost ? '<span class="host-badge">HOST</span>' : '<span class="conn-dot"></span>'}`;
    list.appendChild(li);
  }
  document.getElementById('playerCount').textContent = lobbyPlayers.length;
  const btn = document.getElementById('btnStartGame');
  if (isHost) {
    document.getElementById('hostSettings').style.display = 'flex';
    document.getElementById('hostBotRow').style.display   = 'flex';
    btn.disabled = lobbyPlayers.length < 2;
    btn.textContent = lobbyPlayers.length < 2 ? '‚è≥ Waiting for players‚Ä¶' : `üöÄ Start (${lobbyPlayers.length} players)`;
  } else {
    document.getElementById('hostSettings').style.display = 'none';
    document.getElementById('hostBotRow').style.display   = 'none';
    btn.disabled = true; btn.textContent = '‚è≥ Waiting for host‚Ä¶';
  }
}

function addBotToRoom(difficulty) {
  socket.emit('add_bot', { difficulty });
}

// Handle lobby_update from server (bot add/remove)
socket.on('lobby_update', ({ players }) => {
  lobbyPlayers = players;
  updateLobbyUI();
});
function copyLink() {
  const url = `${window.location.href.split('?')[0]}?room=${currentRoomCode}`;
  navigator.clipboard.writeText(url)
    .then(() => toast('Link copied! üîó'))
    .catch(() => {
      const t = document.createElement('textarea'); t.value = url;
      document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove();
      toast('Link copied! üîó');
    });
}

// ================================================================
//  GAME SCREEN
// ================================================================
function getName(id) { const p = lobbyPlayers.find(p => p.id === id); return p ? p.name : '???'; }
function getAv(id)   { const p = lobbyPlayers.find(p => p.id === id); return p ? p.avatar : '‚ùì'; }

function showGame() {
  ['loginScreen','lobbyScreen','authScreen'].forEach(id => document.getElementById(id).classList.add('hidden'));
  document.getElementById('gameScreen').classList.remove('hidden');
  document.getElementById('myNameDisp').textContent = myName;
  const avEl = document.getElementById('myAvDisp');
  avEl.innerHTML = '';
  if (myAvatar && myAvatar.startsWith('data:')) {
    const img = document.createElement('img'); img.src = myAvatar;
    img.style.cssText = 'width:22px;height:22px;border-radius:50%;object-fit:cover;';
    avEl.appendChild(img);
  } else { avEl.textContent = myAvatar || 'üéÆ'; }
  showXPBar(true);
  updateXPBar();
}

// ================================================================
//  RENDER
// ================================================================
function renderGame() {
  if (!gameActive) return;
  renderDiscard(); renderOpponents(); renderHand(); renderTurn(); renderTurnStrip();
}

function renderDiscard() {
  if (!discardTop) return;
  const pile = document.getElementById('discardPile');
  pile.innerHTML = ''; pile.style.borderRadius = 'var(--radius)';
  const el = makeImg(discardTop); el.style.borderRadius = 'var(--radius)'; el.style.overflow = 'hidden';
  pile.appendChild(el);
  const m = CMETA[currentColor];
  pile.style.boxShadow = m ? `0 4px 20px rgba(0,0,0,0.5),0 0 26px ${m.glow}` : '0 4px 20px rgba(0,0,0,0.5)';
  const sw = document.getElementById('colorSwatch'), lb = document.getElementById('colorLbl');
  if (m) { sw.style.background = m.hex; sw.style.boxShadow = `0 0 12px ${m.glow}`; lb.textContent = m.lbl; }
  document.getElementById('deckRemaining').textContent = `${deckCount} left`;
}

function renderOpponents() {
  const row = document.getElementById('opponentsRow'); row.innerHTML = '';
  const myIdx = turnOrder.indexOf(socket.id), total = turnOrder.length;
  for (let offset = 1; offset < total; offset++) {
    const pid = turnOrder[(myIdx + offset) % total];
    const name = getName(pid), avatar = getAv(pid);
    const cnt = handCounts[pid] || 0;
    const isActive = turnOrder[currentTurnIdx] === pid, hasUno = cnt === 1;
    const panel = document.createElement('div');
    panel.className = 'opp-panel' + (isActive ? ' active' : '');
    panel.dataset.pid = pid;
    if (hasUno) { const b = document.createElement('div'); b.className = 'opp-uno-badge'; b.textContent = 'UNO!'; panel.appendChild(b); }
    const top = document.createElement('div'); top.className = 'opp-top';
    const av = document.createElement('div'); av.className = 'opp-av';
    if (avatar && avatar.startsWith('data:')) {
      const img = document.createElement('img'); img.src = avatar;
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:50%;';
      av.appendChild(img);
    } else { av.textContent = avatar; }
    const nm = document.createElement('div'); nm.className = 'opp-name'; nm.textContent = name;
    top.appendChild(av); top.appendChild(nm); panel.appendChild(top);
    const cardsEl = document.createElement('div'); cardsEl.className = 'opp-cards';
    const show = Math.min(cnt, 8);
    for (let i = 0; i < show; i++) {
      const cm = document.createElement('div'); cm.className = 'opp-cm';
      cm.appendChild(makeBack()); cardsEl.appendChild(cm);
    }
    panel.appendChild(cardsEl);
    const cc = document.createElement('div'); cc.className = 'opp-cnt';
    cc.textContent = `${cnt} card${cnt !== 1 ? 's' : ''}`; panel.appendChild(cc);
    row.appendChild(panel);
  }
}

function renderHand() {
  const inner = document.getElementById('handInner'); inner.innerHTML = '';
  const myTurn = isMyTurn();
  for (const card of myHand) {
    const el = document.createElement('div'); el.className = 'hand-card';
    const playable = myTurn && canPlay(card);
    if (playable) el.classList.add('playable');
    if (myTurn && !playable) el.classList.add('dead');
    if (selectedCard === card) el.classList.add('selected');
    const iw = makeImg(card); el.appendChild(iw);
    const lbl = document.createElement('div'); lbl.className = 'tap-lbl'; lbl.textContent = '‚ñ∂ Play'; el.appendChild(lbl);
    el.addEventListener('click', () => onCardTap(card, el));
    inner.appendChild(el);
  }
  document.getElementById('yourCount').textContent = `${myHand.length} card${myHand.length !== 1 ? 's' : ''}`;
  document.getElementById('yourUnoBadge').style.display = myHand.length === 1 ? 'block' : 'none';
  document.getElementById('scrollHint').textContent = myHand.length > 7 ? '‚Üê scroll ‚Üí' : '';
  document.getElementById('btnDraw').disabled = !isMyTurn() || !gameActive;
  document.getElementById('btnUno').disabled  = !(isMyTurn() && myHand.length === 2 && gameActive);
}

function renderTurn() {
  const lbl = document.getElementById('turnLabel'), cid = turnOrder[currentTurnIdx];
  if (!cid) return;
  if (cid === socket.id) { lbl.textContent = 'Your Turn!'; lbl.classList.add('mine'); }
  else { lbl.textContent = `${getName(cid)}'s Turn`; lbl.classList.remove('mine'); }
  document.getElementById('dirLabel').textContent = direction === 1 ? '‚ñ∂ Clockwise' : '‚óÄ Counter-CW';
}

function renderTurnStrip() {
  const strip = document.getElementById('turnStrip'); strip.innerHTML = '';
  for (let i = 0; i < turnOrder.length; i++) {
    const d = document.createElement('div');
    d.className = 't-dot' + (i === currentTurnIdx ? ' now' : '');
    d.title = getName(turnOrder[i]); strip.appendChild(d);
  }
}

// ================================================================
//  GAME OVER / REMATCH
// ================================================================
function showGameOver(iWon) {
  if (iWon) spawnConfetti();
  document.getElementById('winEmoji').textContent = iWon ? 'üéâ' : 'üíÄ';
  document.getElementById('winTtl').textContent   = iWon ? `üèÜ ${myName} Wins!` : 'Game Over!';
  document.getElementById('winSub').textContent   = iWon ? 'You cleared your hand ‚Äî UNO champion!' : 'Better luck next time!';
  const sl = document.getElementById('scoreList'); sl.innerHTML = '';
  const medals = ['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£'];
  finishOrder.forEach((pid, i) => {
    const li = document.createElement('li');
    const av = getAv(pid);
    const avHtml = av && av.startsWith('data:')
      ? `<div style="width:26px;height:26px;border-radius:50%;overflow:hidden;flex-shrink:0"><img src="${av}" style="width:100%;height:100%;object-fit:cover"></div>`
      : `<span style="font-size:18px;flex-shrink:0">${av}</span>`;
    li.innerHTML = `<span class="score-pos">${medals[i]||(i+1)}</span>${avHtml}<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1">${getName(pid)}</span>`;
    if (pid === socket.id) li.style.background = 'rgba(255,215,0,0.12)';
    sl.appendChild(li);
  });
  rematchVotes = new Set(); updateRematchBtn();
  document.getElementById('winModal').style.display = 'flex';
}
function updateRematchBtn() {
  const btn = document.getElementById('btnPlayAgain');
  const voted = rematchVotes.has(socket.id);
  if (voted) { btn.textContent = `‚è≥ Waiting‚Ä¶ (${rematchVotes.size}/${lobbyPlayers.length})`; btn.disabled = true; btn.style.opacity = '0.6'; }
  else        { btn.textContent = 'üîÑ Play Again'; btn.disabled = false; btn.style.opacity = '1'; }
  btn.style.display = 'inline-block';
}
function requestRematch() { rematchVotes.add(socket.id); updateRematchBtn(); socket.emit('rematch_vote'); }

// ================================================================
//  BANNER / CONFETTI / TOAST
// ================================================================
let bannerTimer = null;
function showBanner(msg) {
  const b = document.getElementById('actionBanner'); b.textContent = msg; b.classList.add('show');
  clearTimeout(bannerTimer); bannerTimer = setTimeout(() => b.classList.remove('show'), 2600);
}
function spawnConfetti() {
  const cols = ['#e8192c','#f5d400','#1e9e46','#0156a8','#fff','#FFD700','#ff69b4'];
  for (let i = 0; i < 80; i++) {
    const c = document.createElement('div'); c.className = 'confetti-p';
    const sz = 6 + Math.random()*8;
    c.style.cssText = `left:${Math.random()*100}vw;width:${sz}px;height:${sz}px;background:${cols[Math.floor(Math.random()*cols.length)]};animation-duration:${1.5+Math.random()*2}s;animation-delay:${Math.random()*0.8}s;border-radius:${Math.random()>0.5?'50%':'2px'};`;
    document.body.appendChild(c); setTimeout(() => c.remove(), 4000);
  }
}
let toastT;
function toast(msg) {
  const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
  clearTimeout(toastT); toastT = setTimeout(() => t.classList.remove('show'), 2400);
}

// ================================================================
//  UI HELPERS
// ================================================================
function showConn(t) { document.getElementById('connectingText').textContent = t; document.getElementById('connectingIndicator').classList.add('show'); }
function hideConn()  { document.getElementById('connectingIndicator').classList.remove('show'); }
function showErr(m)  { const e = document.getElementById('loginError'); e.textContent = m; e.classList.add('show'); }
function hideErr()   { document.getElementById('loginError').classList.remove('show'); }

// ================================================================
//  AUTH
// ================================================================
function hashPassword(pw) { let h=0; for(let i=0;i<pw.length;i++){h=((h<<5)-h)+pw.charCodeAt(i);h|=0;} return h.toString(36); }

function compressAvatar(file, cb) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image(); img.onload = () => {
      const canvas = document.createElement('canvas'), size = 160;
      canvas.width = size; canvas.height = size;
      const ctx = canvas.getContext('2d');
      const min = Math.min(img.width, img.height);
      const sx = (img.width-min)/2, sy = (img.height-min)/2;
      ctx.drawImage(img, sx, sy, min, min, 0, 0, size, size);
      cb(canvas.toDataURL('image/jpeg', 0.7));
    }; img.src = e.target.result;
  }; reader.readAsDataURL(file);
}
function handleAvatarUpload(inp) {
  if (!inp.files || !inp.files[0]) return;
  compressAvatar(inp.files[0], dataUrl => {
    const prev = document.getElementById('registerAvatarPreview');
    prev.innerHTML = `<img src="${dataUrl}">`; prev._avatarData = dataUrl;
  });
}
function changeProfilePic(inp) {
  if (!inp.files || !inp.files[0]) return;
  compressAvatar(inp.files[0], dataUrl => {
    const acc = getAccount(); if (!acc) return;
    acc.avatarData = dataUrl; saveAccount(acc); myAvatar = dataUrl;
    document.getElementById('profileAvDisp').innerHTML = `<img src="${dataUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    toast('Profile photo updated! üì∏');
  });
}
function switchAuthTab(tab) {
  document.getElementById('authLoginForm').style.display    = tab === 'login'    ? 'block' : 'none';
  document.getElementById('authRegisterForm').style.display = tab === 'register' ? 'block' : 'none';
  document.getElementById('tabLogin').classList.toggle('active',    tab === 'login');
  document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
}
function getAccount()    { try { const a = localStorage.getItem('uno_account'); return a ? JSON.parse(a) : null; } catch(e) { return null; } }
function saveAccount(a)  { try { localStorage.setItem('uno_account', JSON.stringify(a)); } catch(e) { toast('Storage full ‚Äî avatar may be too large'); } }
function doRegister() {
  const username = document.getElementById('registerUsername').value.trim();
  const pw  = document.getElementById('registerPassword').value;
  const pw2 = document.getElementById('registerPassword2').value;
  const errEl = document.getElementById('registerAuthError');
  const showE = m => { errEl.textContent = m; errEl.classList.add('show'); };
  errEl.classList.remove('show');
  if (!username)          { showE('Please enter a username'); return; }
  if (username.length < 2){ showE('Username too short (min 2 chars)'); return; }
  if (!pw)                { showE('Please enter a password'); return; }
  if (pw !== pw2)         { showE('Passwords do not match'); return; }
  if (getAccount())       { showE('Account already exists on this device. Login instead.'); return; }
  const prev = document.getElementById('registerAvatarPreview');
  const acc = { uid:'uid_'+Date.now()+'_'+Math.random().toString(36).slice(2), username, passwordHash:hashPassword(pw), avatarData:prev._avatarData||null };
  saveAccount(acc); loginWithAccount(acc);
}
function doLogin() {
  const username = document.getElementById('loginUsername').value.trim();
  const pw  = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginAuthError');
  const showE = m => { errEl.textContent = m; errEl.classList.add('show'); };
  errEl.classList.remove('show');
  const acc = getAccount();
  if (!acc)                                                      { showE('No account found. Please register first.'); return; }
  if (acc.username.toLowerCase() !== username.toLowerCase())     { showE('Username not found'); return; }
  if (acc.passwordHash !== hashPassword(pw))                     { showE('Wrong password'); return; }
  loginWithAccount(acc);
}
function loginWithAccount(acc) {
  myUID = acc.uid; myName = acc.username; myAvatar = acc.avatarData || 'üéÆ';
  try { localStorage.setItem('uno_loggedin','1'); } catch(e) {}
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('profileNameDisp').textContent = myName;
  const avDisp = document.getElementById('profileAvDisp');
  avDisp.innerHTML = acc.avatarData
    ? `<img src="${acc.avatarData}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`
    : 'üéÆ';
  const roomParam = new URLSearchParams(window.location.search).get('room');
  if (roomParam) { document.getElementById('roomCodeInput').value = roomParam.toUpperCase(); toast('Room code pre-filled! üîó'); }
}
function doLogout() {
  try { localStorage.removeItem('uno_loggedin'); } catch(e) {}
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('authScreen').classList.remove('hidden');
  myUID = null; myName = 'Player'; myAvatar = 'üéÆ';
  switchAuthTab('login');
  const acc = getAccount();
  if (acc) {
    document.getElementById('loginUsername').value = acc.username;
    document.getElementById('loginAvatarPreview').innerHTML = acc.avatarData
      ? `<img src="${acc.avatarData}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : 'üë§';
  }
}

// ================================================================
//  AUTO-LOGIN ON LOAD
// ================================================================
window.addEventListener('load', () => {
  const acc = getAccount();
  const loggedIn = localStorage.getItem('uno_loggedin') === '1';
  if (acc && loggedIn) { loginWithAccount(acc); }
  else if (acc) {
    document.getElementById('loginUsername').value = acc.username;
    if (acc.avatarData) document.getElementById('loginAvatarPreview').innerHTML = `<img src="${acc.avatarData}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    setTimeout(() => document.getElementById('loginPassword').focus(), 100);
  }
});

// Key shortcuts
document.getElementById('loginPassword').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
document.getElementById('registerPassword2').addEventListener('keydown', e => { if (e.key === 'Enter') doRegister(); });
document.getElementById('roomCodeInput').addEventListener('input', e => { e.target.value = e.target.value.toUpperCase(); });
document.getElementById('roomCodeInput').addEventListener('keydown', e => { if (e.key === 'Enter') joinRoom(); });

// Prevent zoom on mobile
document.addEventListener('touchstart', e => { if (e.touches.length > 1) e.preventDefault(); }, { passive:false });
let lastT = 0;
document.addEventListener('touchend', e => { const n = Date.now(); if (n - lastT <= 300) e.preventDefault(); lastT = n; }, false);
document.addEventListener('gesturestart', e => e.preventDefault());
</script>
</body>
</html>
